{{define "rds-metrics"}}
<div class="divide-y divide-base-200">
    {{if .Metrics}}
        {{range .Metrics}}
        <details class="collapse collapse-arrow border-b border-base-200 bg-base-100"
                 data-preserve-attr="open"
                 data-show="($rdsEnv == 'all' || $rdsEnv == '{{.Env}}'.split(':')[0]) && ($selectedRdsDb == '' || $selectedRdsDb == '{{.DBInstanceId}}')">>
            <summary class="collapse-title min-h-0 py-4 cursor-pointer">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="badge badge-ghost badge-sm">{{.Env}}</span>
                        <span class="font-medium">{{.DBInstanceId}}</span>
                        {{if not .PerformanceInsightsEnabled}}
                        <span class="badge badge-warning badge-xs">PI Disabled</span>
                        {{end}}
                    </div>
                    <div class="text-xs text-base-content/60">
                        {{if .PerformanceInsightsEnabled}}
                        CPU: <span class="font-mono {{cpuColorClass .CPUCurrent}}">{{printf "%.1f" .CPUCurrent}}%</span>
                        <span class="text-base-content/40">(avg: {{printf "%.1f" .CPUAverage}}%, max: {{printf "%.1f" .CPUMax}}%)</span>
                        {{end}}
                    </div>
                </div>
            </summary>
            <div class="collapse-content pb-4">
                {{if not .PerformanceInsightsEnabled}}
                <div class="alert alert-warning text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span>Performance Insights is not enabled for this database instance. Enable it in the AWS Console to view metrics.</span>
                </div>
                {{else if .Error}}
                <div class="alert alert-error text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>{{.Error}}</span>
                </div>
                {{else}}
                <div class="space-y-3">
                    <!-- Database Info -->
                    <div class="flex flex-wrap items-center gap-4 text-xs text-base-content/60 bg-base-200/30 rounded-lg p-3">
                        <div>Engine: <span class="font-mono">{{.Engine}}</span></div>
                        <div>Status: <span class="font-mono">{{.Status}}</span></div>
                        <div>Resource ID: <span class="font-mono text-[10px]">{{.DBResourceId}}</span></div>
                    </div>

                    <!-- Connection Pool Stats -->
                    {{if gt .ConnectionPool.MaxConnections 0}}
                    <div class="stats stats-horizontal shadow w-full bg-base-100">
                        <div class="stat">
                            <div class="stat-figure text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div class="stat-title text-xs">Active Connections</div>
                            <div class="stat-value text-primary text-2xl">{{.ConnectionPool.ActiveConnections}}</div>
                            <div class="stat-desc text-xs">
                                of {{.ConnectionPool.MaxConnections}} max
                                {{if eq .ConnectionPool.MaxConnectionsSource "api"}}
                                <span class="badge badge-success badge-xs ml-1" title="Retrieved from RDS Parameter Group API">API</span>
                                {{else if eq .ConnectionPool.MaxConnectionsSource "formula"}}
                                <span class="badge badge-info badge-xs ml-1" title="Calculated using engine-specific formula">Formula</span>
                                {{end}}
                            </div>
                        </div>

                        <div class="stat">
                            <div class="stat-figure text-secondary">
                                <div class="radial-progress text-secondary" style="--value:{{printf "%.0f" .ConnectionPool.UsedPercent}}; --size:3rem;" role="progressbar">
                                    <span class="text-xs">{{printf "%.0f" .ConnectionPool.UsedPercent}}%</span>
                                </div>
                            </div>
                            <div class="stat-title text-xs">Pool Usage</div>
                            <div class="stat-value text-2xl {{if ge .ConnectionPool.UsedPercent 80.0}}text-error{{else if ge .ConnectionPool.UsedPercent 60.0}}text-warning{{else}}text-success{{end}}">
                                {{printf "%.0f" .ConnectionPool.UsedPercent}}%
                            </div>
                            <div class="stat-desc text-xs">
                                {{if ge .ConnectionPool.UsedPercent 80.0}}
                                <span class="text-error">⚠ High usage</span>
                                {{else if ge .ConnectionPool.UsedPercent 60.0}}
                                <span class="text-warning">⚡ Moderate</span>
                                {{else}}
                                <span class="text-success">✓ Healthy</span>
                                {{end}}
                            </div>
                        </div>

                        <div class="stat">
                            <div class="stat-figure text-base-content/40">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                </svg>
                            </div>
                            <div class="stat-title text-xs">Idle Connections</div>
                            <div class="stat-value text-2xl text-base-content/70">{{.ConnectionPool.IdleConnections}}</div>
                            <div class="stat-desc text-xs">~{{printf "%.0f" (divf (mulf (float64 .ConnectionPool.IdleConnections) 100.0) (float64 .ConnectionPool.ActiveConnections))}}% of active</div>
                        </div>
                    </div>
                    {{end}}

                    <!-- Top Queries Section -->
                    {{if eq (len .TopQueries) 0}}
                    <div class="p-4 text-xs text-base-content/60 italic text-center">
                        No query activity in the last {{$.MetricHours}} hours.
                    </div>
                    {{else}}
                    <div>
                        <h4 class="text-xs font-semibold mb-2 text-base-content/70">Top Queries (Last {{$.MetricHours}}h)</h4>
                        <div class="overflow-x-auto">
                            <table class="table table-xs">
                                <thead>
                                    <tr>
                                        <th class="w-1/2">Query</th>
                                        <th>DB Load (AAS)</th>
                                        <th>Calls/sec</th>
                                        <th>Avg Latency</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range $idx, $query := .TopQueries}}
                                    <tr>
                                        <td class="font-mono text-[10px] max-w-md break-words">
                                            {{truncate $query.QueryText 150}}
                                        </td>
                                        <td class="text-xs">{{printf "%.2f" $query.DBLoad}}</td>
                                        <td class="text-xs">{{printf "%.1f" $query.CallsPerSec}}</td>
                                        <td class="text-xs">{{printf "%.1f" $query.AvgLatencyMs}}ms</td>
                                        <td>
                                            <button class="btn btn-ghost btn-xs"
                                                    type="button"
                                                    data-on:click="$rds_query_db_load = {{$query.DBLoad}}; $rds_query_calls_per_sec = {{$query.CallsPerSec}}; $rds_query_avg_latency = {{$query.AvgLatencyMs}}; $rds_query_text = `{{$query.QueryText}}`; $rds_query_modal_open = true; event.stopPropagation();">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                </svg>
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
        </details>
        {{end}}
    {{else}}
    <div class="py-10 text-center text-base-content/60 italic text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
        </svg>
        <div>No RDS instances found with Performance Insights enabled.</div>
        <div class="text-xs text-base-content/40 mt-1">Check your AWS configuration and IAM permissions.</div>
    </div>
    {{end}}
</div>
{{end}}
