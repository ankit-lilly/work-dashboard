{{define "active-jobs"}}
<table class="table table-xs w-full text-sm">
        <thead class="text-xs uppercase text-base-content/50">
            <tr>
                <th class="w-28">Env</th>
                <th>Job</th>
                <th>Execution</th>
                <th class="w-24">Duration</th>
            </tr>
        </thead>
        <tbody id="active-jobs-body" class="divide-y divide-base-200">
            {{range .Jobs}}
            <tr class="hover{{if .New}} flash-new{{end}}"
                data-show="($failuresEnv == 'all' || $failuresEnv == ('{{.Env}}'.includes(':') ? '{{.Env}}'.split(':')[0] : '{{.Env}}')) && ((($failuresSearch || '').trim() == '') || el.innerText.toLowerCase().includes($failuresSearch.toLowerCase()))">
                <td>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-ghost badge-sm">
                            {{.Env}}
                        </span>
                        {{if .Stale}}
                        <span class="badge badge-ghost badge-xs">stale</span>
                        {{end}}
                    </div>
                </td>
                <td class="font-medium">{{.Name}}</td>
                <td class="font-mono text-xs text-base-content/60">{{.ExecutionName}}</td>
                <td class="text-xs">{{.Duration}}</td>
            </tr>
            {{else}}
            <tr>
                <td colspan="4" class="py-10 text-center text-base-content/60 italic">
                    {{if .Joke}}
                    <div class="text-sm text-base-content/60">
                        No active executions for now.
                    </div>
                    <div class="mt-2 text-sm text-base-content/60">
                        {{.Joke}}
                    </div>
                    {{else}}
                    No active executions found across configured environments.
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
{{end}}

{{define "recent-completed"}}
<div class="divide-y divide-base-200">
    {{if .Jobs}}
        {{range .Jobs}}
        <details class="collapse collapse-arrow border border-base-200 bg-base-100/90{{if .New}} flash-new{{end}}">
            <summary class="collapse-title text-xs font-medium">
                <span class="badge badge-ghost badge-xs mr-2">{{.Env}}</span>
                <span class="font-mono break-all">{{.ExecutionName}}</span>
                <span class="ml-2 text-base-content/60">{{.Name}}</span>
                {{if .StartTime}}<span class="ml-2 text-base-content/60">{{formatTimeLocal .StartTime}}</span>{{end}}
                {{if .StopTime}}<span class="ml-2 text-base-content/40">→ {{formatTimeLocal .StopTime}}</span>{{end}}
            </summary>
            <div class="collapse-content space-y-3">
                <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-base-content/60">
                    <div>
                        {{if .StartTime}}Start: {{formatTimeLocal .StartTime}}{{end}}
                        {{if .StopTime}}<span class="ml-2">Stop: {{formatTimeLocal .StopTime}}</span>{{end}}
                        {{if .Duration}}<span class="ml-2">Duration: {{.Duration}}</span>{{end}}
                    </div>
                    <div>
                        {{template "states-viewer-link" (dict "Env" .Env "ExecutionArn" .ExecutionArn)}}
                    </div>
                </div>

                {{if or .InputBucket .OutputPrefix}}
                <details class="collapse collapse-arrow border border-base-200 bg-base-100/80">
                    <summary class="collapse-title text-xs font-medium">Input / Output Files</summary>
                    {{if .InputBucket}}
                    <div class="collapse-content space-y-2 text-xs text-base-content/60">
                        <div class="break-all font-mono text-[11px] leading-snug rounded-box bg-base-200/70 px-2 py-1">
                            Input: {{.InputBucket}}/{{.InputKey}}
                            {{if .InputSize}}<span class="ml-2">({{.InputSize}})</span>{{end}}
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <a class="btn btn-outline btn-xs"
                               href="/api/s3-download?env={{.Env}}&bucket={{.InputBucket}}&key={{.InputKey}}">
                                Download Input
                            </a>
                        </div>
                    </div>
                    {{end}}

                    {{if .OutputPrefix}}
                    <div class="collapse-content space-y-2 text-xs text-base-content/60">
                        <div class="break-all font-mono text-[11px] leading-snug rounded-box bg-base-200/70 px-2 py-1">
                            Output Prefix: {{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}/{{.OutputPrefix}}
                        </div>
                        {{if .OutputManifestKey}}
                        <div class="break-all">
                            Manifest: {{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}/{{.OutputManifestKey}}
                            <a class="link link-primary ml-2" href="/api/s3-download?env={{.Env}}&bucket={{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}&key={{.OutputManifestKey}}">
                                Download
                            </a>
                        </div>
                        {{end}}
                        <form class="flex flex-wrap items-center gap-2"
                              data-on:submit="@get('/api/s3-prefix-list', {contentType: 'form', openWhenHidden: true, requestCancellation: 'disabled'})"
                              data-indicator:s3_prefix_loading>
                            <input type="hidden" name="env" value="{{.Env}}" />
                            <input type="hidden" name="bucket" value="{{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}" />
                            <input type="hidden" name="prefix" value="{{.OutputPrefix}}" />
                            <input type="hidden" name="target_id" value="recent-completed-output-{{idSafe .ExecutionArn}}" />
                            <button type="submit" class="btn btn-outline btn-xs">
                                List Output Files
                            </button>
                            {{if .OutputManifestKey}}
                            <a class="btn btn-outline btn-xs"
                               href="/api/s3-download?env={{.Env}}&bucket={{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}&key={{.OutputManifestKey}}">
                                Download Manifest
                            </a>
                            {{end}}
                            <span data-show="$s3_prefix_loading" class="inline-flex items-center gap-1 text-[11px]" style="display:none">
                                <span class="loading loading-spinner loading-xs"></span>
                                Loading...
                            </span>
                        </form>
                        <div id="recent-completed-output-{{idSafe .ExecutionArn}}" class="mt-2"></div>
                    </div>
                    {{end}}
                </details>
                {{end}}
            </div>
        </details>
        {{end}}
    {{else}}
    <div class="p-4 text-sm text-base-content/60">No completed executions in the last 15 minutes.</div>
    {{end}}
</div>
{{end}}

{{define "record-search-results"}}
<div id="record-search-results" class="mt-4 card bg-base-100 shadow-sm border border-base-200 overflow-hidden"
     data-signals:record-search-key="'{{.SearchKey}}'">
    {{if .Error}}
    <div class="p-4 text-sm text-error">Search error: {{.Error}}</div>
    {{end}}

    {{template "record-search-status" .}}

    <div id="record-search-rows" class="max-h-[420px] overflow-auto divide-y divide-base-200">
        {{template "record-search-rows" .}}
    </div>
</div>
{{end}}

{{define "record-search-rows"}}
{{range .Results}}
<details class="collapse collapse-arrow border border-base-200 bg-base-100/80 flash-new">
    <summary class="collapse-title flex items-start justify-between gap-3">
        <div class="min-w-0">
            <div class="text-sm font-semibold">{{.StateMachine}}</div>
            <div class="text-xs text-base-content/60 break-all">
                <span class="badge badge-ghost badge-sm mr-2">{{.Env}}</span>
                {{.ExecutionName}} · {{.StartTime}}
            </div>
            <div class="text-xs text-base-content/60 break-all">
                {{.Bucket}}/{{.Key}} · Index {{.Index}}
            </div>
        </div>
        <div class="flex items-center gap-2 text-xs">
            {{template "states-viewer-link" (dict "Env" .Env "ExecutionArn" .ExecutionArn)}}
            <a class="link link-primary" href="/api/s3-download?env={{.Env}}&bucket={{.Bucket}}&key={{.Key}}">
                Download
            </a>
        </div>
    </summary>
        <div class="collapse-content">
            <div class="flex flex-wrap items-center gap-3">
                <form data-on:submit="@get('/api/s3-preview', {contentType: 'form', openWhenHidden: true, requestCancellation: 'disabled'})">
                <input type="hidden" name="env" value="{{.Env}}" />
                <input type="hidden" name="bucket" value="{{.Bucket}}" />
                <input type="hidden" name="key" value="{{.Key}}" />
                <input type="hidden" name="index" value="{{.Index}}" />
                <input type="hidden" name="target_id" value="record-json-{{idSafe .ExecutionArn}}-{{.Index}}" />
                <button type="submit" class="btn btn-link btn-xs px-0">View JSON</button>
            </form>
            <a class="link link-primary text-xs" href="/api/s3-download?env={{.Env}}&bucket={{.Bucket}}&key={{.Key}}">
                Download File
            </a>
            {{if .OutputPrefix}}
            <form class="flex flex-wrap items-center gap-2"
                  data-on:submit="@get('/api/s3-prefix-list', {contentType: 'form', openWhenHidden: true, requestCancellation: 'disabled'})"
                  data-indicator:s3_prefix_loading>
                <input type="hidden" name="env" value="{{.Env}}" />
                <input type="hidden" name="bucket" value="{{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.Bucket}}{{end}}" />
                <input type="hidden" name="prefix" value="{{.OutputPrefix}}" />
                <input type="hidden" name="target_id" value="record-output-{{idSafe .ExecutionArn}}-{{.Index}}" />
                <button type="submit" class="btn btn-outline btn-xs">
                    List Output Files
                </button>
                {{if .OutputKey}}
                <a class="btn btn-outline btn-xs"
                   href="/api/s3-download?env={{.Env}}&bucket={{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.Bucket}}{{end}}&key={{.OutputKey}}">
                    Download Manifest
                </a>
                {{end}}
                <span data-show="$s3_prefix_loading" class="inline-flex items-center gap-1 text-[11px]" style="display:none">
                    <span class="loading loading-spinner loading-xs"></span>
                    Loading...
                </span>
            </form>
            {{end}}
        </div>
        <div id="record-json-{{idSafe .ExecutionArn}}-{{.Index}}" class="mt-3 max-h-[320px] overflow-auto rounded-box border border-base-200 bg-base-200 p-3 text-xs font-mono"></div>
        {{if .OutputPrefix}}
        <div id="record-output-{{idSafe .ExecutionArn}}-{{.Index}}" class="mt-3"></div>
        {{end}}
    </div>
</details>
{{end}}
{{end}}

{{define "record-search-status"}}
<div id="record-search-status" class="p-4 text-xs uppercase tracking-wide text-base-content/50 border-b border-base-200">
    {{if .Searching}}
        Searching for {{.Email}}...
    {{else if .Stopped}}
        Search stopped.
    {{else if .Email}}
        Results for {{.Email}}
    {{else}}
        Ready to search.
    {{end}}
</div>
{{end}}

{{define "state-machines-list"}}
<ul class="menu menu-sm w-full">
    {{if .Items}}
        {{range .Items}}
        <li class="shadow-sm">
        <button class="menu-item justify-between w-full text-left h-auto py-3"
            data-show="($smEnv == 'all' || $smEnv == '{{.Env}}' || $smEnv == '{{.BaseEnv}}') && el.innerText.toLowerCase().includes($smSearch.toLowerCase())"
            data-on:click="$selectedSm = '{{.Arn}}'; @get('/api/state-machine-executions?env={{.Env}}&arn={{.Arn}}', {openWhenHidden: true, requestCancellation: 'disabled'})"
            data-indicator:sm_exec_loading
            data-class="{
                'btn-active': $selectedSm == '{{.Arn}}',
                'ring-2': $selectedSm == '{{.Arn}}',
                'ring-primary/30': $selectedSm == '{{.Arn}}',
                'font-semibold': $selectedSm == '{{.Arn}}'
            }">
            <div class="flex items-center justify-between gap-2">
                <div>
                    <div class="text-sm font-medium">{{.Name}}</div>
                    <div class="text-xs text-base-content/60 break-all">{{.Arn}}</div>
                </div>
                <span class="badge badge-ghost badge-sm">{{.Env}}</span>
            </div>
        </button>
        </li>
        {{end}}
    {{else}}
    <li class="px-4 py-3 text-sm text-base-content/60">No state machines found.</li>
    {{end}}
</ul>
{{end}}

{{define "state-machine-executions"}}
<div class="divide-y divide-base-200">
    <div id="state-machine-executions-rows" class="divide-y divide-base-200">
        {{template "state-machine-executions-rows" .}}
    </div>
    <div id="state-machine-executions-footer">
        {{template "state-machine-executions-footer" .}}
    </div>
</div>
{{end}}

{{define "state-machine-executions-rows"}}
    {{if .Executions}}
        {{range .Executions}}
        <details class="collapse collapse-arrow border border-base-200 bg-base-100/90">
            <summary class="collapse-title text-xs font-medium">
                <span class="font-mono break-all">{{.Name}}</span>
                <span class="badge badge-ghost badge-xs ml-2">{{.Status}}</span>
                {{if .StartTime}}<span class="ml-2 text-base-content/60">{{.StartTime}}</span>{{end}}
                {{if .StopTime}}<span class="ml-2 text-base-content/40">→ {{.StopTime}}</span>{{end}}
            </summary>
            <div class="collapse-content space-y-3">
                <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-base-content/60">
                    <div>
                        Start: {{.StartTime}}
                        {{if .StopTime}}<span class="ml-2">Stop: {{.StopTime}}</span>{{end}}
                        {{if .Duration}}<span class="ml-2">Duration: {{.Duration}}</span>{{end}}
                    </div>
                    <div>
                        {{template "states-viewer-link" (dict "Env" .Env "ExecutionArn" .Arn)}}
                    </div>
                </div>

                {{if or .InputBucket .OutputPrefix}}
                <details class="collapse collapse-arrow border border-base-200 bg-base-100/80">
                    <summary class="collapse-title text-xs font-medium">Input / Output Files</summary>
                    {{if .InputBucket}}
                    <div class="collapse-content space-y-2 text-xs text-base-content/60">
                        <div class="break-all font-mono text-[11px] leading-snug rounded-box bg-base-200/70 px-2 py-1">
                            Input: {{.InputBucket}}/{{.InputKey}}
                            {{if .InputSize}}<span class="ml-2">({{.InputSize}})</span>{{end}}
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <a class="btn btn-outline btn-xs"
                               href="/api/s3-download?env={{.Env}}&bucket={{.InputBucket}}&key={{.InputKey}}">
                                Download Input
                            </a>
                            <form class="flex flex-wrap items-center gap-2"
                                  data-on:submit="@get('/api/s3-search', {contentType: 'form', openWhenHidden: true, requestCancellation: 'disabled'})"
                                  data-indicator:s3_search_loading>
                                <input type="hidden" name="env" value="{{.Env}}" />
                                <input type="hidden" name="bucket" value="{{.InputBucket}}" />
                                <input type="hidden" name="key" value="{{.InputKey}}" />
                                <input type="hidden" name="target_id" value="s3-search-results-{{idSafe .Arn}}" />
                                <input name="query" type="text" placeholder="Search in JSON..."
                                    class="input input-bordered input-xs w-44" />
                                <button type="submit"
                                    class="btn btn-primary btn-xs">
                                    Search
                                </button>
                                <span data-show="$s3_search_loading" class="inline-flex items-center gap-1 text-[11px]" style="display:none">
                                    <span class="loading loading-spinner loading-xs"></span>
                                    Searching...
                                </span>
                            </form>
                        </div>
                        <div id="s3-search-results-{{idSafe .Arn}}" class="mt-2"></div>
                    </div>
                    {{end}}

                    {{if .OutputPrefix}}
                    <div class="collapse-content space-y-2 text-xs text-base-content/60">
                        <div class="break-all font-mono text-[11px] leading-snug rounded-box bg-base-200/70 px-2 py-1">
                            Output Prefix: {{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}/{{.OutputPrefix}}
                        </div>
                        {{if .OutputManifestKey}}
                        <div class="break-all">
                            Manifest: {{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}/{{.OutputManifestKey}}
                            <a class="link link-primary ml-2" href="/api/s3-download?env={{.Env}}&bucket={{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}&key={{.OutputManifestKey}}">
                                Download
                            </a>
                        </div>
                        {{end}}
                        <form class="flex flex-wrap items-center gap-2"
                              data-on:submit="@get('/api/s3-prefix-list', {contentType: 'form', openWhenHidden: true, requestCancellation: 'disabled'})"
                              data-indicator:s3_prefix_loading>
                            <input type="hidden" name="env" value="{{.Env}}" />
                            <input type="hidden" name="bucket" value="{{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}" />
                            <input type="hidden" name="prefix" value="{{.OutputPrefix}}" />
                            <input type="hidden" name="target_id" value="s3-prefix-results-{{idSafe .Arn}}" />
                            <button type="submit" class="btn btn-outline btn-xs">
                                List Output Files
                            </button>
                            {{if .OutputManifestKey}}
                            <a class="btn btn-outline btn-xs"
                               href="/api/s3-download?env={{.Env}}&bucket={{if .OutputBucket}}{{.OutputBucket}}{{else}}{{.InputBucket}}{{end}}&key={{.OutputManifestKey}}">
                                Download Manifest
                            </a>
                            {{end}}
                            <span data-show="$s3_prefix_loading" class="inline-flex items-center gap-1 text-[11px]" style="display:none">
                                <span class="loading loading-spinner loading-xs"></span>
                                Loading...
                            </span>
                        </form>
                        <div id="s3-prefix-results-{{idSafe .Arn}}" class="mt-2"></div>
                    </div>
                    {{end}}
                </details>
                {{end}}
            </div>
        </details>
        {{end}}
    {{else}}
    <div class="p-4 text-sm text-base-content/60">No executions found.</div>
    {{end}}
{{end}}

{{define "state-machine-executions-footer"}}
    {{if and .Env .Arn}}
        {{if .HasMore}}
        <div class="p-3">
            <button type="button" class="btn btn-outline btn-xs"
                data-indicator:sm_exec_loading
                data-class="{'btn-disabled pointer-events-none opacity-60': $sm_exec_loading}"
                data-on:click="@get('/api/state-machine-executions?env={{.Env}}&arn={{.Arn}}&count={{.CountNext}}&append=1&offset={{.Count}}', {openWhenHidden: true, requestCancellation: 'disabled'})">
                Load more
            </button>
            <span class="ml-2 inline-flex items-center gap-1 text-[11px] text-base-content/60">
                <span data-show="$sm_exec_loading" class="inline-flex items-center gap-1" style="display:none">
                    <span class="loading loading-spinner loading-xs"></span>
                    Loading...
                </span>
                <span data-show="!$sm_exec_loading">Showing {{.Count}}</span>
            </span>
        </div>
        {{else}}
        <div class="p-3 text-[11px] text-base-content/50">
            Showing {{.Count}}
        </div>
        {{end}}
    {{end}}
{{end}}

{{define "s3-search-results"}}
<div id="{{.Target}}" class="card bg-base-100 shadow-sm border border-base-200 overflow-hidden">
    {{if .Error}}
    <div class="p-3 text-xs text-error">Search error: {{.Error}}</div>
    {{end}}
    {{if .Matches}}
    <table class="table table-xs w-full text-xs">
        <thead class="text-[10px] uppercase text-base-content/50">
            <tr>
                <th>Index</th>
                <th>Record</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-base-200">
            {{range .Matches}}
            <tr class="hover">
                <td class="font-mono">{{.Index}}</td>
                <td class="font-mono break-all">{{.Record}}</td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <div class="p-3 text-xs text-base-content/60">No matches for "{{.Query}}".</div>
    {{end}}
</div>
{{end}}

{{define "s3-prefix-results"}}
<div id="{{.Target}}" class="card bg-base-100 shadow-sm border border-base-200 overflow-hidden">
    {{if .Error}}
    <div class="p-3 text-xs text-error">List error: {{.Error}}</div>
    {{end}}
    {{if .Items}}
    <table class="table table-xs w-full text-xs">
        <thead class="text-[10px] uppercase text-base-content/50">
            <tr>
                <th>Key</th>
                <th>Size</th>
                <th>Last Modified</th>
                <th>View</th>
                <th>Download</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-base-200">
            {{range .Items}}
            <tr class="hover">
                <td class="font-mono break-all">{{.Key}}</td>
                <td>{{.Size}}</td>
                <td>{{.LastModified}}</td>
                <td>
                    {{template "json-viewer-link" (dict "Env" $.Env "Bucket" $.Bucket "Key" .Key)}}
                </td>
                <td>
                    <a class="link link-primary" href="/api/s3-download?env={{$.Env}}&bucket={{$.Bucket}}&key={{.Key}}">
                        Download
                    </a>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <div class="p-3 text-xs text-base-content/60">No output files found.</div>
    {{end}}
</div>
{{end}}

{{define "json-viewer-link"}}
<button type="button"
        class="link link-primary"
        data-on:click="$json_modal_open = true; @get('/api/s3-preview-modal?env={{.Env}}&bucket={{.Bucket}}&key={{.Key}}&target_id=json-modal-content', {openWhenHidden: true, requestCancellation: 'disabled'})">
    View JSON
</button>
{{end}}

{{define "states-viewer-link"}}
<button type="button"
        class="link link-primary"
        data-on:click="$states_modal_open = true; @get('/api/execution-states?env={{.Env}}&arn={{.ExecutionArn}}&target_id=states-modal-content', {openWhenHidden: true, requestCancellation: 'disabled'})">
    View States
</button>
{{end}}

{{define "json-modal-content"}}
<div class="flex flex-wrap items-start justify-between gap-3">
    <div class="min-w-0">
        <div class="text-sm font-semibold">JSON Preview</div>
        <div class="text-xs text-base-content/60 break-all">{{.Bucket}}/{{.Key}}</div>
    </div>
    <div class="flex items-center gap-2">
        <a class="btn btn-outline btn-xs"
           href="/api/s3-download?env={{.Env}}&bucket={{.Bucket}}&key={{.Key}}">
            Download
        </a>
        <button type="button" class="btn btn-ghost btn-xs" data-on:click="$json_modal_open = false">
            Close
        </button>
    </div>
</div>
<div class="mt-3">
    {{if .Error}}
    <div class="p-3 text-xs text-error">{{.Error}}</div>
    {{else}}
    <pre class="max-h-[70vh] overflow-auto rounded-box border border-base-200 bg-base-200 p-3 text-xs font-mono whitespace-pre-wrap">{{.PreviewHTML}}</pre>
    {{end}}
</div>
{{end}}

{{define "s3-preview"}}
<div id="{{.Target}}" class="max-h-[320px] overflow-auto rounded-box border border-base-200 bg-base-200 p-3 text-xs font-mono">
    {{if .Error}}
    <div class="text-error">{{.Error}}</div>
    {{else}}
    <pre class="whitespace-pre-wrap">{{.PreviewHTML}}</pre>
    {{end}}
</div>
{{end}}

{{define "recent-failures"}}
<table class="table table-xs w-full text-sm">
        <thead class="text-xs uppercase text-base-content/50">
            <tr>
                <th class="w-28">Env</th>
                <th>Job</th>
                <th class="w-32">Failed</th>
                <th>Error</th>
                <th class="w-20">States</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-base-200"
            data-effect="
                const env = ($failuresEnv || 'all');
                const q = ($failuresSearch || '').toLowerCase().trim();
                for (const row of el.querySelectorAll('tr[data-env]')) {
                    const rowEnv = row.dataset.env || '';
                    const baseEnv = rowEnv.split(':')[0] || rowEnv;
                    const envMatch = env === 'all' || env === baseEnv;
                    const textMatch = !q || row.innerText.toLowerCase().includes(q);
                    row.hidden = !(envMatch && textMatch);
                }
            ">
            {{range .Failures}}
            <tr class="hover{{if .New}} flash-new{{end}}" data-env="{{.Env}}">
                <td>
                    <span class="badge badge-ghost badge-sm">
                        {{.Env}}
                    </span>
                </td>
                <td class="font-medium">{{.Name}}</td>
                <td class="text-base-content/60 text-xs">{{.FailedAt}}</td>
            <td>
                    <span class="text-error font-medium">{{.ErrorType}}</span>
                    {{if .FailureReason}}
                    <div class="mt-1 text-xs text-base-content/60 break-words">
                        {{.FailureReason}}
                    </div>
                    {{end}}
            </td>
                <td>
                    {{template "states-viewer-link" (dict "Env" .Env "ExecutionArn" .ExecutionArn)}}
                </td>
            </tr>
            {{else}}
            <tr>
                <td colspan="5" class="py-10 text-center text-base-content/60 italic">
                    No failures in the last 24 hours. Keep it up!
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
{{end}}


{{define "states-modal-content"}}
<div class="flex flex-wrap items-start justify-between gap-3">
    <div class="min-w-0">
        <div class="text-sm font-semibold">Execution States</div>
        <div class="text-xs text-base-content/60 break-all">{{.ExecutionArn}}</div>
        {{if .StateMachine}}
        <div class="text-xs text-base-content/60 break-all">{{.StateMachine}}</div>
        {{end}}
    </div>
    <div class="flex items-center gap-2">
        <button type="button" class="btn btn-ghost btn-xs" data-on:click="$states_modal_open = false">
            Close
        </button>
    </div>
</div>
<div class="mt-3 space-y-3">
    {{if .Error}}
    <div class="p-3 text-xs text-error">{{.Error}}</div>
    {{end}}
    {{if .States}}
    <div class="space-y-2">
        {{range .States}}
        <details class="collapse collapse-arrow border border-base-200 bg-base-100">
            <summary class="collapse-title text-xs font-medium">
                {{.Name}}
                {{if .StateType}}<span class="ml-2 text-base-content/60">({{.StateType}})</span>{{end}}
                {{if .Status}}<span class="ml-2 badge badge-ghost badge-xs">{{.Status}}</span>{{end}}
            </summary>
            <div class="collapse-content text-xs text-base-content/70 space-y-3">
                <div class="grid grid-cols-1 gap-2 md:grid-cols-2">
                    <div><span class="font-semibold">Entered:</span> {{.EnterTime}}</div>
                    <div><span class="font-semibold">Exited:</span> {{.ExitTime}}</div>
                </div>
                {{if .Error}}
                <div>
                    <div class="font-semibold">Error</div>
                    <div class="break-words">{{.Error}}</div>
                </div>
                {{end}}
                {{if .Cause}}
                <div>
                    <div class="font-semibold">Cause</div>
                    <pre class="max-h-[220px] overflow-auto rounded-box border border-base-200 bg-base-200 p-3 text-xs font-mono whitespace-pre-wrap">{{.Cause}}</pre>
                </div>
                {{end}}
                {{if .Input}}
                <div>
                    <div class="font-semibold">Input</div>
                    <pre class="max-h-[260px] overflow-auto rounded-box border border-base-200 bg-base-200 p-3 text-xs font-mono whitespace-pre-wrap">{{.Input}}</pre>
                </div>
                {{end}}
                {{if .Output}}
                <div>
                    <div class="font-semibold">Output</div>
                    <pre class="max-h-[260px] overflow-auto rounded-box border border-base-200 bg-base-200 p-3 text-xs font-mono whitespace-pre-wrap">{{.Output}}</pre>
                </div>
                {{end}}
            </div>
        </details>
        {{end}}
    </div>
    {{else}}
    <div class="p-3 text-xs text-base-content/60">No state history available.</div>
    {{end}}
</div>
{{end}}
