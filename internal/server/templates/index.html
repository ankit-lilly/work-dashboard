{{define "content"}}
<div class="space-y-6" 
     data-signals="{ json_modal_open: false, states_modal_open: false, active_jobs: [], recent_failures: [], selectedSm: '', smEnv: 'all', smSearch: '', failuresEnv: 'all', failuresSearch: '', sm_exec_loading: false, s3_search_loading: false, s3_prefix_loading: false }"
     data-init="@get('/api/dashboard-updates', {openWhenHidden: true, requestCancellation: 'disabled'})">
    
    <!-- Active Executions Section -->
    <section id="active-executions-section">
        <div class="card bg-base-100/60 border border-base-200">
            <div class="card-body">
                <div class="flex flex-wrap items-center gap-2">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-semibold tracking-tight">Active Executions</h2>
                            <span class="badge badge-ghost badge-sm">Live</span>
                        </div>
                        <div class="text-xs text-base-content/60">Streaming updates from running workflows.</div>
                    </div>
                    <div class="ml-auto flex items-center gap-2 text-xs text-base-content/60">
                        <span class="relative flex h-2.5 w-2.5">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-60"></span>
                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-success"></span>
                        </span>
                        <span>Live updates</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-sm border border-base-200 mt-4">
            <div id="active-jobs-list" class="overflow-x-auto">
                {{if .ActiveJobsError}}
                <div class="p-6 text-sm text-error">
                    Failed to load active executions. {{.ActiveJobsError}}
                </div>
                {{else if .ActiveJobs}}
                {{template "active-jobs" (dict "Jobs" .ActiveJobs "Joke" .ActiveJobsJoke)}}
                {{else}}
                <div class="p-8 text-center text-base-content/60">
                    Polling for active jobs...
                </div>
                {{end}}
            </div>
        </div>
    </section>

    <!-- Recent Failures Section -->
    <section id="recent-failures-section">
        <div class="card bg-base-100/60 border border-base-200">
            <div class="card-body">
                <div class="flex flex-wrap items-center gap-2">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-semibold tracking-tight">Recent Failures</h2>
                            <span class="badge badge-ghost badge-sm">Last 24h</span>
                        </div>
                        <div class="text-xs text-base-content/60">Most recent failed executions across environments.</div>
                    </div>
                    <div class="ml-auto flex flex-wrap items-center gap-2">
                        <div class="join">
                            <input id="failures-search"
                                type="text"
                                class="input input-bordered input-sm join-item w-44 md:w-56"
                                placeholder="Search failures..."
                                data-bind="failuresSearch"
                                data-on:input="$failuresSearch = evt.target.value" />
                            <select id="failures-env"
                                class="select select-bordered select-sm join-item w-28"
                                data-bind="failuresEnv"
                                data-on:change="$failuresEnv = evt.target.value">
                                <option value="all">All</option>
                                <option value="dev">Dev</option>
                                <option value="qa">QA</option>
                                <option value="prod">Prod</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="recent-failures-list" class="card bg-base-100 shadow-sm border border-base-200 h-[320px] min-h-[320px] max-h-[320px] overflow-y-auto mt-4">
            {{if .RecentFailuresError}}
            <div class="p-6 text-sm text-error">
                Failed to load recent failures. {{.RecentFailuresError}}
            </div>
            {{else if .RecentFailures}}
            {{template "recent-failures" (dict "Failures" .RecentFailures)}}
            {{else}}
            <div class="p-8 text-center text-base-content/60">
                Loading recent failures...
            </div>
            {{end}}
        </div>
    </section>

    <!-- State Machines Section -->
    <section id="state-machines-section">
        <div class="card bg-base-100/60 border border-base-200">
            <div class="card-body">
                <div class="flex flex-wrap items-center gap-2">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-semibold tracking-tight">State Machines</h2>
                            <span class="badge badge-ghost badge-sm">Last 10 execs</span>
                        </div>
                        <div class="text-xs text-base-content/60">Click a state machine to load recent executions.</div>
                    </div>
                    <div class="ml-auto flex flex-wrap items-center gap-2">
                        <div class="join">
                            <input id="sm-search"
                                type="text"
                                class="input input-bordered input-sm join-item w-44 md:w-64"
                                placeholder="Search state machines..."
                                data-bind="smSearch" />
                            <select id="sm-env"
                                class="select select-bordered select-sm join-item w-28"
                                data-bind="smEnv">
                                <option value="all">All</option>
                                <option value="dev">Dev</option>
                                <option value="qa">QA</option>
                                <option value="prod">Prod</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-2 lg:grid-cols-2 mt-2">
            <div id="state-machines-list" class="card bg-base-100 shadow-sm border border-base-200 min-h-[240px] max-h-[240px] overflow-y-auto">
                {{if .StateMachinesError}}
                <div class="p-4 text-sm text-error">
                    Failed to load state machines. {{.StateMachinesError}}
                </div>
                {{else if .StateMachines}}
                {{template "state-machines-list" (dict "Items" .StateMachines)}}
                {{else}}
                <div class="p-4 text-sm text-base-content/60">
                    Waiting for state machines...
                </div>
                {{end}}
            </div>
            <div id="state-machine-executions" class="relative card bg-base-100 shadow-sm border border-base-200 min-h-[240px] max-h-[240px] overflow-y-auto">
                <div class="absolute inset-0 flex items-center justify-center bg-base-100/80 backdrop-blur-sm"
                    data-show="$sm_exec_loading" style="display: none">
                    <div class="flex items-center gap-2 text-sm text-base-content/60">
                        <span class="loading loading-spinner loading-sm"></span>
                        <span>Loading executions...</span>
                    </div>
                </div>
                <div id="state-machine-executions-content" class="p-4 text-sm text-base-content/60">
                    Select a state machine to view recent executions.
                </div>
            </div>
        </div>
    </section>

    <!-- Record Tracer Section -->
    <section id="record-tracer-section">
        <div class="card bg-base-100/60 border border-base-200">
            <div class="card-body">
                <div class="flex flex-wrap items-center gap-2">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-semibold tracking-tight">Record Tracer</h2>
                            <span class="badge badge-ghost badge-sm">Search</span>
                        </div>
                        <div class="text-xs text-base-content/60">Locate records by email across environments.</div>
                    </div>
                </div>
                <form class="mt-4 flex flex-col gap-2 md:flex-row md:items-center"
                      data-on:submit="@get('/api/record-search', {contentType: 'form', openWhenHidden: true, requestCancellation: 'disabled'})">
                    <input id="email_address" name="email_address" type="text"
                        class="input input-bordered input-sm w-full md:flex-1"
                        placeholder="Email address" />
                    <select id="env" name="env" class="select select-bordered select-sm w-full md:w-36">
                        <option value="all">All envs</option>
                        <option value="dev">Dev</option>
                        <option value="qa">QA</option>
                        <option value="prod">Prod</option>
                    </select>
                    <input id="hours" name="hours" type="number" min="1" value="24"
                        class="input input-bordered input-sm w-full md:w-28"
                        placeholder="Hours" />
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">Search</button>
                        <button type="button" class="btn btn-outline btn-sm"
                            data-on:click="@get('/api/record-search-cancel?key=' + $recordSearchKey)">
                            Stop
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="record-search-results" class="mt-2 card bg-base-100 shadow-sm border border-base-200">
            <div class="p-4 text-sm text-base-content/60">
                Enter an email address to search recent executions.
            </div>
        </div>
    </section>

    <div class="modal" data-class="{'modal-open': $json_modal_open}">
        <div class="modal-box max-w-5xl">
            <div id="json-modal-content" class="min-h-[120px]">
                <div class="p-4 text-sm text-base-content/60">Loading JSON preview...</div>
            </div>
        </div>
        <div class="modal-backdrop" data-on:click="$json_modal_open = false">
            <button type="button">close</button>
        </div>
    </div>

    <div class="modal" data-class="{'modal-open': $states_modal_open}">
        <div class="modal-box max-w-5xl">
            <div id="states-modal-content" class="min-h-[120px]">
                <div class="p-4 text-sm text-base-content/60">Loading execution states...</div>
            </div>
        </div>
        <div class="modal-backdrop" data-on:click="$states_modal_open = false">
            <button type="button">close</button>
        </div>
    </div>
</div>
{{end}}
